{
	"$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"factoryName": {
			"type": "string",
			"metadata": "Data Factory name",
			"defaultValue": "wagsdm"
		}
	},
	"variables": {
		"factoryId": "[concat('Microsoft.DataFactory/factories/', parameters('factoryName'))]"
	},
	"resources": [
		{
			"name": "[concat(parameters('factoryName'), '/cphyper')]",
			"type": "Microsoft.DataFactory/factories/pipelines",
			"apiVersion": "2018-06-01",
			"properties": {
				"activities": [
					{
						"name": "cpblobtohyperscale",
						"type": "ExecuteDataFlow",
						"dependsOn": [],
						"policy": {
							"timeout": "0.00:10:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"dataflow": {
								"referenceName": "cpblobtohyperscale",
								"type": "DataFlowReference"
							},
							"compute": {
								"coreCount": 8,
								"computeType": "General"
							}
						}
					}
				],
				"annotations": []
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/dataflows/cpblobtohyperscale')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/taxiblobsqldw')]",
			"type": "Microsoft.DataFactory/factories/pipelines",
			"apiVersion": "2018-06-01",
			"properties": {
				"activities": [
					{
						"name": "taxiblobsqldw",
						"type": "ExecuteDataFlow",
						"dependsOn": [],
						"policy": {
							"timeout": "7.00:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"dataflow": {
								"referenceName": "taxiblobsqldw",
								"type": "DataFlowReference"
							},
							"staging": {
								"linkedService": {
									"referenceName": "AzureBlobStorage1",
									"type": "LinkedServiceReference"
								},
								"folderPath": "staging"
							},
							"compute": {
								"coreCount": 8,
								"computeType": "General"
							}
						}
					}
				],
				"annotations": []
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/dataflows/taxiblobsqldw')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/greentaxi')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "AzureBlobStorage1",
					"type": "LinkedServiceReference"
				},
				"annotations": [],
				"type": "Parquet",
				"typeProperties": {
					"location": {
						"type": "AzureBlobStorageLocation",
						"folderPath": "nyctlc/green",
						"container": "opendataset"
					},
					"compressionCodec": "snappy"
				},
				"schema": [
					{
						"name": "vendorID",
						"type": "INT32"
					},
					{
						"name": "lpepPickupDatetime",
						"type": "INT96"
					},
					{
						"name": "lpepDropoffDatetime",
						"type": "INT96"
					},
					{
						"name": "passengerCount",
						"type": "INT32"
					},
					{
						"name": "tripDistance",
						"type": "DOUBLE"
					},
					{
						"name": "puLocationId",
						"type": "UTF8"
					},
					{
						"name": "doLocationId",
						"type": "UTF8"
					},
					{
						"name": "pickupLongitude",
						"type": "DOUBLE"
					},
					{
						"name": "pickupLatitude",
						"type": "DOUBLE"
					},
					{
						"name": "dropoffLongitude",
						"type": "DOUBLE"
					},
					{
						"name": "dropoffLatitude",
						"type": "DOUBLE"
					},
					{
						"name": "rateCodeID",
						"type": "INT32"
					},
					{
						"name": "storeAndFwdFlag",
						"type": "UTF8"
					},
					{
						"name": "paymentType",
						"type": "INT32"
					},
					{
						"name": "fareAmount",
						"type": "DOUBLE"
					},
					{
						"name": "extra",
						"type": "DOUBLE"
					},
					{
						"name": "mtaTax",
						"type": "DOUBLE"
					},
					{
						"name": "improvementSurcharge",
						"type": "UTF8"
					},
					{
						"name": "tipAmount",
						"type": "DOUBLE"
					},
					{
						"name": "tollsAmount",
						"type": "DOUBLE"
					},
					{
						"name": "ehailFee",
						"type": "DOUBLE"
					},
					{
						"name": "totalAmount",
						"type": "DOUBLE"
					},
					{
						"name": "tripType",
						"type": "INT32"
					},
					{
						"name": "puYear",
						"type": "UTF8"
					},
					{
						"name": "puMonth",
						"type": "UTF8"
					}
				]
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/greentaxids')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "idicdm",
					"type": "LinkedServiceReference"
				},
				"annotations": [],
				"type": "AzureSqlDWTable",
				"schema": [
					{
						"name": "vendorID",
						"type": "int",
						"precision": 10
					},
					{
						"name": "lpepPickupDatetime",
						"type": "datetime",
						"precision": 23,
						"scale": 3
					},
					{
						"name": "lpepDropoffDatetime",
						"type": "datetime",
						"precision": 23,
						"scale": 3
					},
					{
						"name": "passengerCount",
						"type": "int",
						"precision": 10
					},
					{
						"name": "tripDistance",
						"type": "float",
						"precision": 15
					},
					{
						"name": "puLocationId",
						"type": "varchar"
					},
					{
						"name": "doLocationId",
						"type": "varchar"
					},
					{
						"name": "pickupLongitude",
						"type": "float",
						"precision": 15
					},
					{
						"name": "pickupLatitude",
						"type": "float",
						"precision": 15
					},
					{
						"name": "dropoffLongitude",
						"type": "float",
						"precision": 15
					},
					{
						"name": "dropoffLatitude",
						"type": "float",
						"precision": 15
					},
					{
						"name": "rateCodeID",
						"type": "int",
						"precision": 10
					},
					{
						"name": "storeAndFwdFlag",
						"type": "varchar"
					},
					{
						"name": "paymentType",
						"type": "int",
						"precision": 10
					},
					{
						"name": "fareAmount",
						"type": "float",
						"precision": 15
					},
					{
						"name": "extra",
						"type": "float",
						"precision": 15
					},
					{
						"name": "mtaTax",
						"type": "float",
						"precision": 15
					},
					{
						"name": "improvementSurcharge",
						"type": "varchar"
					},
					{
						"name": "tipAmount",
						"type": "float",
						"precision": 15
					},
					{
						"name": "tollsAmount",
						"type": "float",
						"precision": 15
					},
					{
						"name": "ehailFee",
						"type": "float",
						"precision": 15
					},
					{
						"name": "totalAmount",
						"type": "float",
						"precision": 15
					},
					{
						"name": "tripType",
						"type": "int",
						"precision": 10
					},
					{
						"name": "puYear",
						"type": "int",
						"precision": 10
					},
					{
						"name": "puMonth",
						"type": "int",
						"precision": 10
					}
				],
				"typeProperties": {
					"schema": "dbo",
					"table": "GreenCab_RawData"
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/idicdmyellow')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "idicdm",
					"type": "LinkedServiceReference"
				},
				"annotations": [],
				"type": "AzureSqlDWTable",
				"schema": [
					{
						"name": "vendorID",
						"type": "varchar"
					},
					{
						"name": "tpepPickupDateTime",
						"type": "datetime",
						"precision": 23,
						"scale": 3
					},
					{
						"name": "tpepDropoffDateTime",
						"type": "datetime",
						"precision": 23,
						"scale": 3
					},
					{
						"name": "passengerCount",
						"type": "int",
						"precision": 10
					},
					{
						"name": "tripDistance",
						"type": "float",
						"precision": 15
					},
					{
						"name": "puLocationId",
						"type": "varchar"
					},
					{
						"name": "doLocationId",
						"type": "varchar"
					},
					{
						"name": "startLon",
						"type": "float",
						"precision": 15
					},
					{
						"name": "startLat",
						"type": "float",
						"precision": 15
					},
					{
						"name": "endLon",
						"type": "float",
						"precision": 15
					},
					{
						"name": "endLat",
						"type": "float",
						"precision": 15
					},
					{
						"name": "rateCodeId",
						"type": "int",
						"precision": 10
					},
					{
						"name": "storeAndFwdFlag",
						"type": "varchar"
					},
					{
						"name": "paymentType",
						"type": "varchar"
					},
					{
						"name": "fareAmount",
						"type": "float",
						"precision": 15
					},
					{
						"name": "extra",
						"type": "float",
						"precision": 15
					},
					{
						"name": "mtaTax",
						"type": "float",
						"precision": 15
					},
					{
						"name": "improvementSurcharge",
						"type": "varchar"
					},
					{
						"name": "tipAmount",
						"type": "float",
						"precision": 15
					},
					{
						"name": "tollsAmount",
						"type": "float",
						"precision": 15
					},
					{
						"name": "totalAmount",
						"type": "float",
						"precision": 15
					}
				],
				"typeProperties": {
					"schema": "dbo",
					"table": "YellowCab_Rawdata"
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/cpblobtohyperscale')]",
			"type": "Microsoft.DataFactory/factories/dataflows",
			"apiVersion": "2018-06-01",
			"properties": {
				"type": "MappingDataFlow",
				"typeProperties": {
					"sources": [
						{
							"dataset": {
								"referenceName": "opendataset",
								"type": "DatasetReference"
							},
							"name": "waginput"
						}
					],
					"sinks": [
						{
							"dataset": {
								"referenceName": "hyperscaleisi",
								"type": "DatasetReference"
							},
							"name": "hyperscale"
						}
					],
					"transformations": [
						{
							"name": "Select1"
						}
					],
					"script": "source(output(\n\t\tvendorID as string,\n\t\ttpepPickupDateTime as timestamp,\n\t\ttpepDropoffDateTime as timestamp,\n\t\tpassengerCount as integer,\n\t\ttripDistance as double,\n\t\tpuLocationId as string,\n\t\tdoLocationId as string,\n\t\tstartLon as double,\n\t\tstartLat as double,\n\t\tendLon as double,\n\t\tendLat as double,\n\t\trateCodeId as integer,\n\t\tstoreAndFwdFlag as string,\n\t\tpaymentType as string,\n\t\tfareAmount as double,\n\t\textra as double,\n\t\tmtaTax as double,\n\t\timprovementSurcharge as string,\n\t\ttipAmount as double,\n\t\ttollsAmount as double,\n\t\ttotalAmount as double,\n\t\tpuYear as string,\n\t\tpuMonth as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tformat: 'parquet') ~> waginput\nwaginput select(mapColumn(\n\t\tvendorID,\n\t\ttpepPickupDateTime,\n\t\ttpepDropoffDateTime,\n\t\tpassengerCount,\n\t\ttripDistance,\n\t\tpuLocationId,\n\t\tdoLocationId,\n\t\tstartLon,\n\t\tstartLat,\n\t\tendLon,\n\t\tendLat,\n\t\trateCodeId,\n\t\tstoreAndFwdFlag,\n\t\tpaymentType,\n\t\tfareAmount,\n\t\textra,\n\t\tmtaTax,\n\t\timprovementSurcharge,\n\t\ttipAmount,\n\t\ttollsAmount,\n\t\ttotalAmount,\n\t\tpuYear,\n\t\tpuMonth\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Select1\nSelect1 sink(input(\n\t\tvendorID as string,\n\t\ttpepPickupDateTime as timestamp,\n\t\ttpepDropoffDateTime as timestamp,\n\t\tpassengerCount as integer,\n\t\ttripDistance as double,\n\t\tpuLocationId as string,\n\t\tdoLocationId as string,\n\t\tstartLon as double,\n\t\tstartLat as double,\n\t\tendLon as double,\n\t\tendLat as double,\n\t\trateCodeId as integer,\n\t\tstoreAndFwdFlag as string,\n\t\tpaymentType as string,\n\t\tfareAmount as double,\n\t\textra as double,\n\t\tmtaTax as double,\n\t\timprovementSurcharge as string,\n\t\ttipAmount as double,\n\t\ttollsAmount as double,\n\t\ttotalAmount as double\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tbatchSize: 1000,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> hyperscale"
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/taxiblobsqldw')]",
			"type": "Microsoft.DataFactory/factories/dataflows",
			"apiVersion": "2018-06-01",
			"properties": {
				"type": "MappingDataFlow",
				"typeProperties": {
					"sources": [
						{
							"dataset": {
								"referenceName": "opendataset",
								"type": "DatasetReference"
							},
							"name": "taxidata"
						},
						{
							"dataset": {
								"referenceName": "greentaxi",
								"type": "DatasetReference"
							},
							"name": "taxigreen"
						}
					],
					"sinks": [
						{
							"dataset": {
								"referenceName": "idicdmyellow",
								"type": "DatasetReference"
							},
							"name": "idicdm"
						},
						{
							"dataset": {
								"referenceName": "greentaxids",
								"type": "DatasetReference"
							},
							"name": "idicdmgreen"
						}
					],
					"transformations": [
						{
							"name": "Select1"
						},
						{
							"name": "Select2"
						}
					],
					"script": "source(output(\n\t\tvendorID as string,\n\t\ttpepPickupDateTime as timestamp,\n\t\ttpepDropoffDateTime as timestamp,\n\t\tpassengerCount as integer,\n\t\ttripDistance as double,\n\t\tpuLocationId as string,\n\t\tdoLocationId as string,\n\t\tstartLon as double,\n\t\tstartLat as double,\n\t\tendLon as double,\n\t\tendLat as double,\n\t\trateCodeId as integer,\n\t\tstoreAndFwdFlag as string,\n\t\tpaymentType as string,\n\t\tfareAmount as double,\n\t\textra as double,\n\t\tmtaTax as double,\n\t\timprovementSurcharge as string,\n\t\ttipAmount as double,\n\t\ttollsAmount as double,\n\t\ttotalAmount as double,\n\t\tpuYear as string,\n\t\tpuMonth as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tformat: 'parquet') ~> taxidata\nsource(output(\n\t\tvendorID as integer,\n\t\tlpepPickupDatetime as timestamp,\n\t\tlpepDropoffDatetime as timestamp,\n\t\tpassengerCount as integer,\n\t\ttripDistance as double,\n\t\tpuLocationId as string,\n\t\tdoLocationId as string,\n\t\tpickupLongitude as double,\n\t\tpickupLatitude as double,\n\t\tdropoffLongitude as double,\n\t\tdropoffLatitude as double,\n\t\trateCodeID as integer,\n\t\tstoreAndFwdFlag as string,\n\t\tpaymentType as integer,\n\t\tfareAmount as double,\n\t\textra as double,\n\t\tmtaTax as double,\n\t\timprovementSurcharge as string,\n\t\ttipAmount as double,\n\t\ttollsAmount as double,\n\t\tehailFee as double,\n\t\ttotalAmount as double,\n\t\ttripType as integer,\n\t\tpuYear as string,\n\t\tpuMonth as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tformat: 'parquet') ~> taxigreen\ntaxidata select(mapColumn(\n\t\tvendorID,\n\t\ttpepPickupDateTime,\n\t\ttpepDropoffDateTime,\n\t\tpassengerCount,\n\t\ttripDistance,\n\t\tpuLocationId,\n\t\tdoLocationId,\n\t\tstartLon,\n\t\tstartLat,\n\t\tendLon,\n\t\tendLat,\n\t\trateCodeId,\n\t\tstoreAndFwdFlag,\n\t\tpaymentType,\n\t\tfareAmount,\n\t\textra,\n\t\tmtaTax,\n\t\timprovementSurcharge,\n\t\ttipAmount,\n\t\ttollsAmount,\n\t\ttotalAmount,\n\t\tpuYear,\n\t\tpuMonth\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Select1\ntaxigreen select(mapColumn(\n\t\tvendorID,\n\t\tlpepPickupDatetime,\n\t\tlpepDropoffDatetime,\n\t\tpassengerCount,\n\t\ttripDistance,\n\t\tpuLocationId,\n\t\tdoLocationId,\n\t\tpickupLongitude,\n\t\tpickupLatitude,\n\t\tdropoffLongitude,\n\t\tdropoffLatitude,\n\t\trateCodeID,\n\t\tstoreAndFwdFlag,\n\t\tpaymentType,\n\t\tfareAmount,\n\t\textra,\n\t\tmtaTax,\n\t\timprovementSurcharge,\n\t\ttipAmount,\n\t\ttollsAmount,\n\t\tehailFee,\n\t\ttotalAmount,\n\t\ttripType,\n\t\tpuYear,\n\t\tpuMonth\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Select2\nSelect1 sink(input(\n\t\tvendorID as string,\n\t\ttpepPickupDateTime as timestamp,\n\t\ttpepDropoffDateTime as timestamp,\n\t\tpassengerCount as integer,\n\t\ttripDistance as double,\n\t\tpuLocationId as string,\n\t\tdoLocationId as string,\n\t\tstartLon as double,\n\t\tstartLat as double,\n\t\tendLon as double,\n\t\tendLat as double,\n\t\trateCodeId as integer,\n\t\tstoreAndFwdFlag as string,\n\t\tpaymentType as string,\n\t\tfareAmount as double,\n\t\textra as double,\n\t\tmtaTax as double,\n\t\timprovementSurcharge as string,\n\t\ttipAmount as double,\n\t\ttollsAmount as double,\n\t\ttotalAmount as double\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> idicdm\nSelect2 sink(input(\n\t\tvendorID as integer,\n\t\tlpepPickupDatetime as timestamp,\n\t\tlpepDropoffDatetime as timestamp,\n\t\tpassengerCount as integer,\n\t\ttripDistance as double,\n\t\tpuLocationId as string,\n\t\tdoLocationId as string,\n\t\tpickupLongitude as double,\n\t\tpickupLatitude as double,\n\t\tdropoffLongitude as double,\n\t\tdropoffLatitude as double,\n\t\trateCodeID as integer,\n\t\tstoreAndFwdFlag as string,\n\t\tpaymentType as integer,\n\t\tfareAmount as double,\n\t\textra as double,\n\t\tmtaTax as double,\n\t\timprovementSurcharge as string,\n\t\ttipAmount as double,\n\t\ttollsAmount as double,\n\t\tehailFee as double,\n\t\ttotalAmount as double,\n\t\ttripType as integer,\n\t\tpuYear as integer,\n\t\tpuMonth as integer\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> idicdmgreen"
				}
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/datasets/greentaxi')]",
				"[concat(variables('factoryId'), '/datasets/idicdmyellow')]",
				"[concat(variables('factoryId'), '/datasets/greentaxids')]"
			]
		}
	]
}